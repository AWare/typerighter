#!/bin/sh -e

set -e

MAX_DB_ATTEMPTS=5

setupTestDeps() {
  docker-compose up -d
  # Ensure localstack is up, and relevant resources have been created
  for ATTEMPT in $(seq 1 $MAX_DB_ATTEMPTS)
  do
    pg_isready -h localhost -p 5432 --quiet -t 5 && echo "Postgres DB – ready" && break
    echo "Postgres DB – waiting ($ATTEMPT/$MAX_DB_ATTEMPTS)"
    sleep 5
  done
}

teardownTestDeps() {
  docker-compose down
}

buildClients() {
  (cd rule-audit-client && npm i && npm run build)
  (cd rule-manager/rule-manager-client && npm i && npm run build)
}

buildSbt() {
  sbt clean compile test riffRaffNotifyTeamcity
}

setup() {
  setupTestDeps
  buildClients
  buildSbt
  teardownTestDeps
}

teardown() {
  teardownTestDeps
}

trap teardown EXIT

setup
teardown
